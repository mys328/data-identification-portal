define(function(require,exports,module){var app=angular.module('app');app.filter("trust",['$sce',function($sce){return function(str){var checkHtml=function(htmlStr){var reg=/<[^>]+>/g;return reg.test(htmlStr)};if(checkHtml(str)){return $sce.trustAsHtml(str)}return str}}]);app.service("tableContentFormatter",function(){this.formatter=function(scope,data,column,childMap){var content=[];var dataArr=angular.copy(data);if(data instanceof Array&&data.length>0){scope.reversal=new Map();var isMapNull=true;if(scope.matchFiled){var arr=[];var f=angular.copy(scope.matchFiled);for(var j=0,l=data.length;j<l;j++){var t=data[j];if(!t[f.pId]&&t[f.id]){arr.push(t);var a=childMap.get(t[f.id]);if(a&&a instanceof Array){arr=arr.concat(a)}}}if(arr.length>0){dataArr=arr}}for(var j=0,l=dataArr.length;j<l;j++){var d=dataArr[j];var fd={};var openFiled=undefined;for(var i=0,len=column.length;i<len;i++){var c=column[i];var t=d[c.filed];if(scope.matchFiled){if(scope.matchFiled.pId==c.filed){scope.matchFiled.pId=i}if(scope.matchFiled.id==c.filed){scope.matchFiled.id=i}}if(isMapNull){scope.reversal.put(i,c.filed)}if(typeof c.formatter=="function"){t=c.formatter.call(this||window,t,d)}if(!openFiled&&c.openChildRow){openFiled=i}if(!t){t=""}fd[i]=t}isMapNull=false;if(fd[openFiled]&&scope.matchFiled&&!fd[scope.matchFiled.pId]){if(childMap.get(fd[openFiled]).length>0){fd[openFiled]="<div class='z-open-child' ng-click='openChild($event)'>"+fd[openFiled]+"</div>"}}content.push(fd)}}return content}});app.directive("fssBillTable",['tableContentFormatter',function(tableContentFormatter){'use strict';return{restrict:"EA",replace:true,templateUrl:"static/template/table.template.html",scope:{tableConfig:'=',selectedRow:'=',pageConfig:'='},link:function(scope,element,attrs){scope.pagingOptions=scope.tableConfig.pagingOptions||false;scope.changeCallBackFn=function(currentPage,pageSize){if(scope.pagingOptions){var changeCallBackFn=scope.tableConfig.pagingChangeFn||null;if(typeof changeCallBackFn=="function"){changeCallBackFn.call(this,currentPage,pageSize)}else{alert("调用pageChange函数出错.")}}};scope.enableSelected=scope.tableConfig.enableSelected||false;scope.multipleCheck=scope.tableConfig.multipleCheck||false;scope.matchFiled=scope.tableConfig.matchFiled||undefined;var filed=angular.copy(scope.matchFiled);scope.column=scope.tableConfig.column||[];scope.getChildMap=function(f,d){var childMap=new Map();if(f){for(var tmp in d){var t=d[tmp];if(!t[f.pId]&&t[f.id]){if(!childMap.get(t[f.id])){childMap.put(t[f.id],[])}}else{if(!(childMap.get(t[f.pId]))&&!(childMap.get(t[f.pId])instanceof Array)){childMap.put(t[f.pId],[])}childMap.get(t[f.pId]).push(t)}}}return childMap};scope.content=tableContentFormatter.formatter(scope,scope.tableConfig.data,scope.column,scope.getChildMap(filed,scope.tableConfig.data));scope.$watch(function(){return JSON.stringify(scope.tableConfig.data)},function(newValue,oldValue){if(newValue!==oldValue){scope.content=tableContentFormatter.formatter(scope,JSON.parse(newValue),scope.column,scope.getChildMap(filed,scope.tableConfig.data))}})},controller:['$scope',function($scope){var prevSelected=undefined;var prevRow=undefined;var checkHtml=function(htmlStr){var reg=/<[^>]+>/g;return reg.test(htmlStr)};$scope.openId=null;$scope.getPId=function($this){var obj=$this.c;if(obj){return obj[$scope.matchFiled.pId]}return null};$scope.stripHTML=function(str){str+="";var reTag=/<(?:.|\s)*?>/g;return str.replace(reTag,"")};$scope.onSelected=function(event){if($scope.enableSelected){var $prev=prevSelected;var $this=angular.element(event.target).parent().hasClass("z-tr")?angular.element(event.target).parent():angular.element(event.target).parent().parent();var classStr=$this.attr("class");if($prev&&$prev!=$this&&$prev.hasClass("z-selected-row")){$prev.removeClass("z-selected-row")}prevSelected=$this;var reversalObj={};if(classStr.indexOf("z-selected-row")>0){$this.removeClass("z-selected-row")}else{$this.addClass("z-selected-row");var data=JSON.parse($this.attr("z-data"));var id=data[$scope.matchFiled.id];if(checkHtml(id)){id=$scope.stripHTML(id);data[$scope.matchFiled.id]=id;for(var f in data){reversalObj[$scope.reversal.get(f)]=data[f]}}else{reversalObj=data}}$scope.selectedRow=reversalObj}};$scope.openChild=function(event){var $this=angular.element(event.target);if($this.hasClass("activi")){$this.css("backgroundImage","url('static/images/icon_check_down.png')");$this.removeClass("activi");$scope.showChildRow=false;$scope.openId=null}else{var $prev=angular.element(prevRow);if(prevRow&&prevRow!=event.target&&$prev.hasClass("activi")){$prev.css("backgroundImage","url('static/images/icon_check_down.png')");$prev.removeClass("activi")}$this.css("backgroundImage","url('static/images/icon_check_up.png')");$this.addClass("activi");$scope.showChildRow=true;$scope.openId=$this.text();prevRow=event.target}}}]}}]);app.directive("dyCompile",["$compile",function($compile){return{replace:true,restrict:'EA',link:function(scope,elm,iAttrs){var DUMMY_SCOPE={$destroy:angular.noop},root=elm,childScope,destroyChildScope=function(){(childScope||DUMMY_SCOPE).$destroy()};var checkHtml=function(htmlStr){var reg=/<[^>]+>/g;return reg.test(htmlStr)};iAttrs.$observe("html",function(html){if(html){destroyChildScope();childScope=scope.$new(false);var content=$compile(html)(childScope);if(!checkHtml(html)){content=html}root.replaceWith(content);root=content}scope.$on("$destroy",destroyChildScope)})}}}])});