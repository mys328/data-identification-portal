(function () {
    var base = angular.module("projectBase", ["uniformUser"]);

    base.factory("GlobalScope", [function () {

        var GlobalVariable = {};
        var msgBus = [];
        return {
            postMessage: function (msgId, args) {
                for (var i = 0;i < msgBus.length;i++) {
                    if (msgId == msgBus[i].msgId) {
                        msgBus[i].callback(args);
                    }
                }
            },
            registerMessage: function (msgId, callback) {
                var item = {
                    msgId: msgId,
                    callback: callback
                };
                msgBus.push(item);

                return function(){
                    var index = msgBus.indexOf(item);
                    msgBus.splice(index, 1);
                };
            },
            setVariable: function (name, value) {
                return GlobalVariable[name] = value;
            },
            getVariable: function (name) {
                return GlobalVariable[name];
            },
            resetGlobalVariable: function () {
                GlobalVariable = {};
            }
        };
    }]);

    base.factory("commonProjectService", ["$http", function ($http) {

        var categorys = {
            "area": "/pm/paas/pm/resource/getConstructionArea.do",
            "organization" : "/pm/paas/pm/resource/getOrganization.do",
            "specialty" : "/pm/paas/pm/resource/getMajorType.do",
            "pm" : "/pm/paas/pm/resource/getUsersByOrgId.do"
        };

        var childrenOfCostTypeCache = {};


        //查询当前登录用户信息
        function getUserInfo(callback, errorCallback) {
            $http.get("/pm/paas/pm/resource/getUserInfo.do").success(function (user) {
                if (callback) {
                    callback(user);
                }
            }).error(errorCallback);
        };
        
        function getDesignFascicle(projId, callback) {//判断是否存在分册
        	$http.jsonp("/pm/paas/pm/resource/getProjFascicleDetail.do?callback=JSON_CALLBACK", {
        		params: {
        			pageSize : 5,
        			currentPage : 1,
        			projId : projId
                }
        	}).success(function (result) {
        		if (callback) {
        			callback(result);
        		}
        	}).error(function (result) {
        		//alert("error:"+result);
        	});
        };
        
        function getDesignFascicleInfo(projId,schId,fcSchId,callback, errorCallback) {
        	$http.get("/pm/process/pm/designInvestigation/getBySchIdAndProjId.do?schId="+schId+"&projId="+projId+"&fcSchId="+fcSchId
               ).success(function (user) {
        		if (callback) {
        			callback(user);
        		}
        	}).error(errorCallback);
        };
        
        //查询当前所在公司信息
        function getCompanyInfo(callback, errorCallback) {
            $http.get("/pm/paas/pm/resource/getCompanyInfo.do").success(function (org) {
                if (callback) {
                    callback(org);
                }
            }).error(errorCallback);
        };
        
        //查询业务字典
        function getByNodeKey(nodeKey, callback, errorCallback) {
            $http.get("/pm/paas/pm/resource/getByNodeKey.do",{
                params: {
                    nodeKey : nodeKey
                }
            }).success(function (dicts) {
                if (callback) {
                    callback(dicts);
                }
            }).error(errorCallback);
        };

        //立项流程审批查询
        function getPageFromBpm(projId, callback, errorCallback) {
            $http.get("/pm/paas/pm/projectInfo/getPageFromBpm.do", {
                params: {
                    businessKey: projId,
                    key: "PROCESS_ITEMKEY_XMLX"
                }
            }).success(function (result) {
                if (callback) {
                    callback(eval(result));
                }
            }).error(errorCallback);
        };

        /**
	      * 附件类型查询
	      * @param activityType
	      * @param callback
	      */
		 function initDoc(activityType,callback){
        	$http.get("/pm/paas/pm/projectDoc/initDoc.do", {
                params: {
                	activityType:activityType
                }
            }).success(function (data) {
                if (callback){
                    callback(data);
                }
            }).error(function (result) {
			 });
        };
		 /**
		  * 上传路径
		  * @param activityType
		  * @param callback
		  */
		 function getUploadUrl(activityType,callback){
			 $http.get("/pm/paas/pm/resource/getAttachmentUploadPath.do", {
				 params: {
					 activityType:activityType
				 }
			 }).success(function (data) {
				 if (callback){
					 callback(data);
				 }
			 }).error(function (result) {
				 alert(result);
			 });
		 };
		 
		 /**
		  * 项目过程查询，根据过程活动查询操作项目
		  */
		 function queryMyProject(pars, callback, errorCallback) {
        	$http.post("/pm/paas/pm/projectProcessInfo/queryProcessProject.do",pars).success(function (data) {
        		if (callback) {
        			callback(data);
        		}
        	}).error(function (result) {
        		alert("error:"+result);
        	});
        };
		 
        /**
         * 扩展查询项目
         */
        function getExtQueryMyProject(pars, callback, errorCallback) {
            $http.post("/pm/paas/pm/projectInfo/getByPermission.do", pars).success(function (data) {    // 成功回调函数， data为标准的pageBean格式json对象
                if (callback) {
                    callback(data);
                }
            }).error(errorCallback);
        };
	        
        /**
         * 获取项目基本信息通过项目Id
         * @param projId    获取项目Id
         * @param callback  成功获取的回调函数
         */
        function getInformation(projId, callback, errorCallback) {
        	$http.get("/pm/paas/pm/projectInfo/getInformation.do", {
        		params: {
        			projId: projId
        		}
        	}).success(function (projectInfo) {  // 返回的项目完整信息
        		if (callback) {
        			callback(projectInfo);
        		}
        	}).error(errorCallback);
        };
        
        /**
         * 根据项目查询项目基础信息 返回ProjectVO对象
         */
        function getProjectVOByProjId(projId, callback, errorCallback) {
        	$http.get("/pm/paas/pm/projectInfo/showBasicProjectInfo.do", {
        		params: {
        			proId: projId
        		}
        	}).success(function (projectInfo) {  // 返回的项目完整信息
        		if (callback) {
        			callback(projectInfo);
        		}
        	}).error(errorCallback);
        };
        
        /**
         * 根据项目查询项目基础信息 返回ProjectInfo对象
         */
        function getProjectInfoByProjId(projId, callback, errorCallback) {
        	$http.get("/pm/paas/pm/projectInfo/getProjectInfoByProjId.do", {
        		params: {
        			proId: projId
        		}
        	}).success(function (projectInfo) {  // 返回的项目完整信息
        		if (callback) {
        			callback(projectInfo);
        		}
        	}).error(errorCallback);
        };
        
        /**
         * 特定项目查询，例如 设计文件加出版、设计文件变更
         */
        function selDesignStopProject(pars, callback) {//查询项目
  		  $http.post("/pm/paas/pm/projectProcessInfo/querySpecificProject.do",pars).success(function (data) {
        		if (callback) {
        			callback(data);
        		}
        	}).error(function (result) {
        		alert("error:"+result);
        	});
        }
        
        return {
        	selDesignStopProject: function (pars, callback) {
        		selDesignStopProject(pars, callback);
             },
            getUserInfo: function (callback, errorCallback) {
                getUserInfo(callback, errorCallback);
            },
            getCompanyInfo : function(callback, errorCallback){
            	getCompanyInfo(callback, errorCallback);
            },
            getByNodeKey: function (nodeKey, callback, errorCallback) {
                getByNodeKey(nodeKey, callback, errorCallback);
            },
            getPageFromBpm: function (projId, callback, errorCallback) {
                getPageFromBpm(projId, callback, errorCallback);
            },
            initDoc:function(activityType,callback){
  				initDoc(activityType,callback);
	   		},
	   		getUploadUrl:function(activityType,callback){
	   			getUploadUrl(activityType,callback);
	   		},
	   		queryMyProject:function(pars, callback, errorCallback){
	   			queryMyProject(pars, callback, errorCallback);
	   		},
	   		getExtQueryMyProject:function(pars, callback, errorCallback){
	   			getExtQueryMyProject(pars, callback, errorCallback);
	   		},
	   		getInformation:function(projId,callback){
	   			getInformation(projId,callback);
	   		},
	   		getProjectVOByProjId:function(projId,callback){
	   			getProjectVOByProjId(projId,callback);
	   		},
	   		getProjectInfoByProjId:function(projId,callback){
	   			getProjectInfoByProjId(projId,callback);
	   		},
	   		getDesignFascicleInfo:function(projId,schId,fcSchId,callback){
	   			getDesignFascicleInfo(projId,schId,fcSchId,callback);
	   		},
	   		getDesignFascicle:function(projId,callback) {
	   			getDesignFascicle(projId,callback);
	   		}
        };
    }]);
    
    /**
	 * PM批量导入数据 
	 */
    base.directive("pmUploadFile", function () {
        return {
            restrict: "AE",
            replace: true,
            template: "<form style='position: relative'><span style='cursor:pointer;'><a class='btn btn-default' href=''><i class='fa fa-sign-in'></i>批量导入</a></span></form>",
            scope: {
                basePath: "=",
                onUploaded: "&"
            },
            compile: function (element, attrs) {
                return function (scope, element, attrs) {
            		element.children().children("a")[0].click();
            		
                    $.PmBindFileUploadEvent({
                        uploadAttachment: element.children().children("a"),
                        basePath: scope.basePath,
                        callBackFunc: function (uploadData) {
                            scope.$apply(function () {
                                scope.onUploaded({uploadData: uploadData});
                            });
                        }
                    });
                }
            }
        };
    });

/**--------------------------------------------------------查询项目公共指令开始--------------------------------------------------------------*/    
	/**
	 * 项目过程活动查询项目信息 页面单个查询 optionProject
	 */
    base.directive("optionProjectDialog", function () {
    	
    	return {
    		restrict: "A",
    		templateUrl: "/pm/commonjs/temp/projectMessage.html",
    		scope: {
    			showDialog: "=",
    			// mdmcode: "=",
    			modalTitle: "@",
    			confirmButton: "@",
    			onSelectedConfirm: "&",
    			schCode:"=",
    			projectId:"=",
    			projType:"="
    		},
    		compile: function (element, attrs) {
    			return function (scope, element, attrs) {
    				scope.dbSelected = function (node) {
    					if (scope.onSelected) {
    						scope.onSelected();
    					}
    					angular.element(element.children("div")[0]).modal("hide");
    				};
    			}
    		},
    		controller: ["$scope", "commonProjectService", function ($scope, commonProjectService) {
    			$scope.showMask = false;
    		
    			//打开窗口时查询
                $scope.onShow = function(){
                	$scope.getProjectList();
                }
    			var view = {
    					showMask : false,
    					selectedProject: null,
    		    		totalPage : 0,
    		    		totalCount : 0,
    		    		pageSize : 5,
    		    		currentPage : 1,
    		    		projectVO : [],
    		    		deptDialog:false
    		    	}
		    	/*
		    	 * 往后台传递的参数(后台要的) 
		    	 */
    			$scope.ProjectType = {
    					GC:"工程项目",	
    					SJ:"设计项目",	
    					JL:"监理项目",	
    					QT:"其它项目",	
    					GY:"应急项目"	
    				}
		    	var data = {
		    			data: {
		    				projShortname:"",
		    				projCode:"",
		    				projCustomCode:"",
		    				chargeOrgName:"",
		    				projOwnerCode:"",
		    				pmName:"",
		    				projStatus:"",
		    				projNature:"",
		    				companyId:"",
		    				projType:"",
		                },
		                pageSize: 5,
		    			currentPage: 1,
		    			totalCount: 0
		            };
    			$scope.view = view;
    			$scope.data = data;
    			$scope.getProjectList = function getProjectList(){
    				$scope.showMask = true;
    				var pb = {
    						pageSize : data.pageSize,
    						currentPage : data.currentPage,
    						totalCount : data.totalCount,
    						data : [{
    							projCode : data.data.projCode,
    							chargeOrg : data.data.chargeOrgId,
    							projName : data.data.projName == undefined ? '' : $scope.projName,
    							projShortname : data.data.projShortname,
    							projCustomCode : data.data.projCustomCode,
    							projOwnerCode :data.data.projOwnerCode,
    							projNature : data.data.projNature,
    							projType : $scope.projType,
    							projStatus : data.data.projStatus,
    							chargeOrgName : data.data.chargeOrgName,
    							pmName : data.data.pmName,
    							pmId : data.data.pmId,
    							schCode : $scope.schCode == undefined ? '' : $scope.schCode,
    						}]
    					}
    				commonProjectService.queryMyProject(pb, function (data) {
    					view.projectVO = data.data;
    					view.totalPage = data.totalPage;
    					view.pageSize = data.pageSize;
    					view.currentPage = data.currentPage;
    					view.totalCount = data.totalCount; 
    					$scope.showMask = false;
    					view.showMask = false;
    				}, function (error) {
    					$scope.showMask = false;
    					view.showMask = false;
    					window.alert(error);
    				});
    			}
    			if($scope.projectId){
    				$scope.getProjectList();
    				$scope.$emit('to-parent', view.projectVO);
    			}
    			//$scope.getProjectList();	
    			
    			//获取部门
    			$scope.selectDept = function (id,name){
    				data.data.chargeOrgId = id;
    				data.data.chargeOrgName = name;
    			}
    			// 项目经理选择回调
                $scope.selectProjectManager = function (userItem) {
                	data.data.pmId = userItem.userId;
                    data.data.pmName = userItem.userName;
                };
    			$scope.switchPage = function (currentPage, pageSize) {
    				view.showMask = true;
    				$scope.showMask = true;
    				data.currentPage = currentPage;
    				data.pageSize = pageSize;
    				$scope.getProjectList();
    			};
    			
    			$scope.selectProject = function(data){
    				$scope.view.selectedProject = data;
    			}
    			   /**
    	         * 公司名称
    	         */
    	        $scope.getCompany= function () {
    	       
    	        	commonProjectService.getCompanyInfo(function(org){
    	            	data.data.companyId = org.companyId;
    	                //$scope.searchData.companyName = data.orgName;
    	            })
    	        };
    	        $scope.getCompany();
    			/**
    			 * 项目信息回调
    			 */
    			$scope.onSelected = function () {
    				if ($scope.onSelectedConfirm) {
    					$scope.onSelectedConfirm({
    						projectVO : view.selectedProject,
    					});
    					$scope.$emit('to-parent', view.selectedProject);
    				}
    			};
    	        
    			//清空
				  $scope.clearUp = function(){
				
				    				data.data.projShortname="";
				    				data.data.projCode="";
				    				data.data.projCustomCode="";
				    				data.data.chargeOrgName="";
				    				data.data.chargeOrgId="";
				    				data.data.projOwnerCode="";
				    				data.data.pmId="";
				    				data.data.pmName="";
				    				data.data.projStatus="";
				    				data.data.projNature="";
				    				data.data.projType="";
				    				data.data.projOwnerCode="";
				      
				            
				  };
    			//双击
    			$scope.dbSelected = function (data) {
    				$scope.view.selectedProject = data;
    				$scope.onSelected();
    			}
    		}]
    	}
    });

	/**
	 * 项目过程活动查询项目信息 批量选择项目 optionProject
	 */
    base.directive("optionProjectesDialog", function () {
    	
    	return {
    		restrict: "A",
    		templateUrl: "/pm/commonjs/temp/multiSelectProjMessage.html",
    		scope: {
    			showDialog: "=",
    			// mdmcode: "=",
    			modalTitle: "@",
    			confirmButton: "@",
    			onSelectedConfirm: "&",
    			schCode:"=",
    			projectId:"=",
    			projType:"="
    		},
    		compile: function (element, attrs) {
    			return function (scope, element, attrs) {
    				scope.dbSelected = function (node) {
    					if (scope.onSelected) {
    						scope.onSelected();
    					}
    					angular.element(element.children("div")[0]).modal("hide");
    				};
    			}
    		},
    		controller: ["$scope", "commonProjectService", function ($scope, commonProjectService) {
    			$scope.showMask = false;
    		
    			//打开窗口时查询
                $scope.onShow = function(){
                	$scope.getProjectList();
                }
    			var view = {
    					showMask : false,
    					selectedProject: null,
    		    		totalPage : 0,
    		    		totalCount : 0,
    		    		pageSize : 5,
    		    		currentPage : 1,
    		    		projectVO : [],
    		    		deptDialog:false
    		    	}
		    	/*
		    	 * 往后台传递的参数(后台要的) 
		    	 */
    			$scope.ProjectType = {
    					GC:"工程项目",	
    					SJ:"设计项目",	
    					JL:"监理项目",	
    					QT:"其它项目",	
    					GY:"应急项目"	
    				}
		    	var data = {
		    			data: {
		    				projShortname:"",
		    				projCode:"",
		    				projCustomCode:"",
		    				chargeOrgName:"",
		    				projOwnerCode:"",
		    				pmName:"",
		    				projStatus:"",
		    				projNature:"",
		    				companyId:"",
		    				projType:"",
		                },
		                pageSize: 5,
		    			currentPage: 1,
		    			totalCount: 0
		            };
    			$scope.view = view;
    			$scope.data = data;
    			$scope.getProjectList = function getProjectList(){
    				$scope.showMask = true;
    				var pb = {
    						pageSize : data.pageSize,
    						currentPage : data.currentPage,
    						totalCount : data.totalCount,
    						data : [{
    							projCode : data.data.projCode,
    							chargeOrg : data.data.chargeOrgId,
    							projName : data.data.projName == undefined ? '' : $scope.projName,
    							projShortname : data.data.projShortname,
    							projCustomCode : data.data.projCustomCode,
    							projOwnerCode :data.data.projOwnerCode,
    							projNature : data.data.projNature,
    							projType : $scope.projType,
    							projStatus : data.data.projStatus,
    							chargeOrgName : data.data.chargeOrgName,
    							pmName : data.data.pmName,
    							pmId : data.data.pmId,
    							schCode : $scope.schCode == undefined ? '' : $scope.schCode,
    						}]
    					}
    				commonProjectService.queryMyProject(pb, function (data) {
    					view.projectVO = data.data;
    					view.totalPage = data.totalPage;
    					view.pageSize = data.pageSize;
    					view.currentPage = data.currentPage;
    					view.totalCount = data.totalCount; 
    					$scope.showMask = false;
    					view.showMask = false;
    				}, function (error) {
    					$scope.showMask = false;
    					view.showMask = false;
    					window.alert(error);
    				});
    			}
    			if($scope.projectId){
    				$scope.getProjectList();
    				$scope.$emit('to-parent', view.projectVO);
    			}
    			//$scope.getProjectList();	
    			
    			//获取部门
    			$scope.selectDept = function (id,name){
    				data.data.chargeOrgId = id;
    				data.data.chargeOrgName = name;
    			}
    			// 项目经理选择回调
                $scope.selectProjectManager = function (userItem) {
                	data.data.pmId = userItem.userId;
                    data.data.pmName = userItem.userName;
                };
    			$scope.switchPage = function (currentPage, pageSize) {
    				view.showMask = true;
    				$scope.showMask = true;
    				data.currentPage = currentPage;
    				data.pageSize = pageSize;
    				$scope.getProjectList();
    			};
    			
    			$scope.selectProject = function(data){
    				$scope.view.selectedProject = data;
    			}
    			   /**
    	         * 公司名称
    	         */
    	        $scope.getCompany= function () {
    	       
    	        	commonProjectService.getCompanyInfo(function(org){
    	            	data.data.companyId = org.companyId;
    	                //$scope.searchData.companyName = data.orgName;
    	            })
    	        };
    	        $scope.getCompany();
    			/**
    			 * 项目信息回调
    			 */
    	         $scope.onSelected = function () {
                     var projectVOList = [];
                     for (var i = 0;i < view.projectVO.length;i++) {
                         if (view.projectVO[i]._checked) {
                        	 projectVOList.push(view.projectVO[i]);
                         }
                     }
                     if ($scope.onSelectedConfirm) {
                         $scope.onSelectedConfirm({
                        	 projectVOList: projectVOList
                         });
                     }
                 };
    	        
    			//清空
				  $scope.clearUp = function(){
				
				    				data.data.projShortname="";
				    				data.data.projCode="";
				    				data.data.projCustomCode="";
				    				data.data.chargeOrgName="";
				    				data.data.chargeOrgId="";
				    				data.data.projOwnerCode="";
				    				data.data.pmId="";
				    				data.data.pmName="";
				    				data.data.projStatus="";
				    				data.data.projNature="";
				    				data.data.projType="";
				    				data.data.projOwnerCode="";
				      
				            
				  };
//    			//双击
//    			$scope.dbSelected = function (data) {
//    				$scope.view.selectedProject = data;
//    				$scope.onSelected();
//    			}
    			
                /**
                 * 判断是否所有项目被选择
                 * @returns {boolean}
                 */
                $scope.isAllSelected = function () {
                    var count = 0;
                    for (var i = 0;i < view.projectVO.length;i++) {
                        if (view.projectVO[i]._checked) {
                            count++;
                        }
                    }
                    return view.selectedAll = (count == view.projectVO.length);
                };

                /**
                 * 选择所有项目
                 */
                $scope.selectAll = function () {
                    for (var i = 0;i < view.projectVO.length;i++) {
                    	view.projectVO[i]._checked = view.selectedAll;
                    }
                };
    			
    		}]
    	}
    });
    
    /**
	 * 扩展项目过程活动查询项目信息 页面单个查询 extOptionProject
	 */
    base.directive("extOptionProjectDialog", function () {
    	
    	return {
    		restrict: "A",
    		templateUrl: "/pm/commonjs/temp/projectMessage.html",
    		scope: {
    			showDialog: "=",
    			// mdmcode: "=",
    			modalTitle: "@",
    			confirmButton: "@",
    			onSelectedConfirm: "&",
    			schCode:"=",
    			projectId:"=",
    			projType:"="
    		},
    		compile: function (element, attrs) {
    			return function (scope, element, attrs) {
    				scope.dbSelected = function (node) {
    					if (scope.onSelected) {
    						scope.onSelected();
    					}
    					angular.element(element.children("div")[0]).modal("hide");
    				};
    			}
    		},
    		controller: ["$scope", "commonProjectService", function ($scope, commonProjectService) {
    			$scope.showMask = false;
    		
    			//打开窗口时查询
                $scope.onShow = function(){
                	$scope.getProjectList();
                }
    			var view = {
    					showMask : false,
    					selectedProject: null,
    		    		totalPage : 0,
    		    		totalCount : 0,
    		    		pageSize : 5,
    		    		currentPage : 1,
    		    		projectVO : [],
    		    		deptDialog:false
    		    	}
		    	/*
		    	 * 往后台传递的参数(后台要的) 
		    	 */
    			$scope.ProjectType = {
    					GC:"工程项目",	
    					SJ:"设计项目",	
    					JL:"监理项目",	
    					QT:"其它项目",	
    					GY:"应急项目"	
    				}
		    	var data = {
		    			data: {
		    				projShortname:"",
		    				projCode:"",
		    				projCustomCode:"",
		    				chargeOrgName:"",
		    				projOwnerCode:"",
		    				pmName:"",
		    				projNature:"",
		    				companyId:"",
		    				projType:"",
		                },
		                pageSize: 5,
		    			currentPage: 1,
		    			totalCount: 0
		            };
    			$scope.view = view;
    			$scope.data = data;
    			$scope.getProjectList = function getProjectList(){
    				$scope.showMask = true;
    				var pb = {
    						pageSize : data.pageSize,
    						currentPage : data.currentPage,
    						totalCount : data.totalCount,
    						data : [{
    							projCode : data.data.projCode,
    							chargeOrg : data.data.chargeOrgId,
    							projName : data.data.projName == undefined ? '' : $scope.projName,
    							projShortname : data.data.projShortname,
    							projCustomCode : data.data.projCustomCode,
    							projOwnerCode :data.data.projOwnerCode,
    							projNature : data.data.projNature,
    							projType : $scope.projType,
    							chargeOrgName : data.data.chargeOrgName,
    							pmName : data.data.pmName,
    							pmId : data.data.pmId,
    							schCode : $scope.schCode == undefined ? '' : $scope.schCode,
    						}]
    					}
    				commonProjectService.getExtQueryMyProject(pb, function (data) {
    					view.projectVO = data.data;
    					view.totalPage = data.totalPage;
    					view.pageSize = data.pageSize;
    					view.currentPage = data.currentPage;
    					view.totalCount = data.totalCount; 
    					$scope.showMask = false;
    					view.showMask = false;
    				}, function (error) {
    					$scope.showMask = false;
    					view.showMask = false;
    					window.alert(error);
    				});
    			}
    			if($scope.projectId){
    				$scope.getProjectList();
    				$scope.$emit('to-parent', view.projectVO);
    			}
    			//$scope.getProjectList();	
    			
    			//获取部门
    			$scope.selectDept = function (id,name){
    				data.data.chargeOrgId = id;
    				data.data.chargeOrgName = name;
    			}
    			// 项目经理选择回调
                $scope.selectProjectManager = function (userItem) {
                	data.data.pmId = userItem.userId;
                    data.data.pmName = userItem.userName;
                };
    			$scope.switchPage = function (currentPage, pageSize) {
    				view.showMask = true;
    				$scope.showMask = true;
    				data.currentPage = currentPage;
    				data.pageSize = pageSize;
    				$scope.getProjectList();
    			};
    			
    			$scope.selectProject = function(data){
    				$scope.view.selectedProject = data;
    			}
    			   /**
    	         * 公司名称
    	         */
    	        $scope.getCompany= function () {
    	       
    	        	commonProjectService.getCompanyInfo(function(org){
    	            	data.data.companyId = org.companyId;
    	                //$scope.searchData.companyName = data.orgName;
    	            })
    	        };
    	        $scope.getCompany();
    			/**
    			 * 项目信息回调
    			 */
    			$scope.onSelected = function () {
    				if ($scope.onSelectedConfirm) {
    					$scope.onSelectedConfirm({
    						projectVO : view.selectedProject,
    					});
    					$scope.$emit('to-parent', view.selectedProject);
    				}
    			};
    	        
    			//清空
				  $scope.clearUp = function(){
				
				    				data.data.projShortname="";
				    				data.data.projCode="";
				    				data.data.projCustomCode="";
				    				data.data.chargeOrgName="";
				    				data.data.chargeOrgId="";
				    				data.data.projOwnerCode="";
				    				data.data.pmId="";
				    				data.data.pmName="";
				    				data.data.projStatus="";
				    				data.data.projNature="";
				    				data.data.projType="";
				    				data.data.projOwnerCode="";
				      
				            
				  };
    			//双击
    			$scope.dbSelected = function (data) {
    				$scope.view.selectedProject = data;
    				$scope.onSelected();
    			}
    		}]
    	}
    });

	/**
	 * 扩展项目过程活动查询项目信息 批量选择项目 extOptionProject
	 */
    base.directive("extOptionProjectesDialog", function () {
    	
    	return {
    		restrict: "A",
    		templateUrl: "/pm/commonjs/temp/multiSelectProjMessage.html",
    		scope: {
    			showDialog: "=",
    			// mdmcode: "=",
    			modalTitle: "@",
    			confirmButton: "@",
    			onSelectedConfirm: "&",
    			schCode:"=",
    			projectId:"=",
    			projType:"="
    		},
    		compile: function (element, attrs) {
    			return function (scope, element, attrs) {
    				scope.dbSelected = function (node) {
    					if (scope.onSelected) {
    						scope.onSelected();
    					}
    					angular.element(element.children("div")[0]).modal("hide");
    				};
    			}
    		},
    		controller: ["$scope", "commonProjectService", function ($scope, commonProjectService) {
    			$scope.showMask = false;
    		
    			//打开窗口时查询
                $scope.onShow = function(){
                	$scope.getProjectList();
                }
    			var view = {
    					showMask : false,
    					selectedProject: null,
    		    		totalPage : 0,
    		    		totalCount : 0,
    		    		pageSize : 5,
    		    		currentPage : 1,
    		    		projectVO : [],
    		    		deptDialog:false
    		    	}
		    	/*
		    	 * 往后台传递的参数(后台要的) 
		    	 */
    			$scope.ProjectType = {
    					GC:"工程项目",	
    					SJ:"设计项目",	
    					JL:"监理项目",	
    					QT:"其它项目",	
    					GY:"应急项目"	
    				}
		    	var data = {
		    			data: {
		    				projShortname:"",
		    				projCode:"",
		    				projCustomCode:"",
		    				chargeOrgName:"",
		    				projOwnerCode:"",
		    				pmName:"",
		    				projNature:"",
		    				companyId:"",
		    				projType:"",
		                },
		                pageSize: 5,
		    			currentPage: 1,
		    			totalCount: 0
		            };
    			$scope.view = view;
    			$scope.data = data;
    			$scope.getProjectList = function getProjectList(){
    				$scope.showMask = true;
    				var pb = {
    						pageSize : data.pageSize,
    						currentPage : data.currentPage,
    						totalCount : data.totalCount,
    						data : [{
    							projCode : data.data.projCode,
    							chargeOrg : data.data.chargeOrgId,
    							projName : data.data.projName == undefined ? '' : $scope.projName,
    							projShortname : data.data.projShortname,
    							projCustomCode : data.data.projCustomCode,
    							projOwnerCode :data.data.projOwnerCode,
    							projNature : data.data.projNature,
    							projType : $scope.projType,
    							chargeOrgName : data.data.chargeOrgName,
    							pmName : data.data.pmName,
    							pmId : data.data.pmId,
    							schCode : $scope.schCode == undefined ? '' : $scope.schCode,
    						}]
    					}
    				commonProjectService.getExtQueryMyProject(pb, function (data) {
    					view.projectVO = data.data;
    					view.totalPage = data.totalPage;
    					view.pageSize = data.pageSize;
    					view.currentPage = data.currentPage;
    					view.totalCount = data.totalCount; 
    					$scope.showMask = false;
    					view.showMask = false;
    				}, function (error) {
    					$scope.showMask = false;
    					view.showMask = false;
    					window.alert(error);
    				});
    			}
    			if($scope.projectId){
    				$scope.getProjectList();
    				$scope.$emit('to-parent', view.projectVO);
    			}
    			//$scope.getProjectList();	
    			
    			//获取部门
    			$scope.selectDept = function (id,name){
    				data.data.chargeOrgId = id;
    				data.data.chargeOrgName = name;
    			}
    			// 项目经理选择回调
                $scope.selectProjectManager = function (userItem) {
                	data.data.pmId = userItem.userId;
                    data.data.pmName = userItem.userName;
                };
    			$scope.switchPage = function (currentPage, pageSize) {
    				view.showMask = true;
    				$scope.showMask = true;
    				data.currentPage = currentPage;
    				data.pageSize = pageSize;
    				$scope.getProjectList();
    			};
    			
    			$scope.selectProject = function(data){
    				$scope.view.selectedProject = data;
    			}
    			   /**
    	         * 公司名称
    	         */
    	        $scope.getCompany= function () {
    	       
    	        	commonProjectService.getCompanyInfo(function(org){
    	            	data.data.companyId = org.companyId;
    	                //$scope.searchData.companyName = data.orgName;
    	            })
    	        };
    	        $scope.getCompany();
    			/**
    			 * 项目信息回调
    			 */
    	         $scope.onSelected = function () {
                     var projectVOList = [];
                     for (var i = 0;i < view.projectVO.length;i++) {
                         if (view.projectVO[i]._checked) {
                        	 projectVOList.push(view.projectVO[i]);
                         }
                     }
                     if ($scope.onSelectedConfirm) {
                         $scope.onSelectedConfirm({
                        	 projectVOList: projectVOList
                         });
                     }
                 };
    	        
    			//清空
				  $scope.clearUp = function(){
				
				    				data.data.projShortname="";
				    				data.data.projCode="";
				    				data.data.projCustomCode="";
				    				data.data.chargeOrgName="";
				    				data.data.chargeOrgId="";
				    				data.data.projOwnerCode="";
				    				data.data.pmId="";
				    				data.data.pmName="";
				    				data.data.projStatus="";
				    				data.data.projNature="";
				    				data.data.projType="";
				    				data.data.projOwnerCode="";
				      
				            
				  };
//    			//双击
//    			$scope.dbSelected = function (data) {
//    				$scope.view.selectedProject = data;
//    				$scope.onSelected();
//    			}
    			
                /**
                 * 判断是否所有项目被选择
                 * @returns {boolean}
                 */
                $scope.isAllSelected = function () {
                    var count = 0;
                    for (var i = 0;i < view.projectVO.length;i++) {
                        if (view.projectVO[i]._checked) {
                            count++;
                        }
                    }
                    return view.selectedAll = (count == view.projectVO.length);
                };

                /**
                 * 选择所有项目
                 */
                $scope.selectAll = function () {
                    for (var i = 0;i < view.projectVO.length;i++) {
                    	view.projectVO[i]._checked = view.selectedAll;
                    }
                };
    			
    		}]
    	}
    });
    
    //特定项目选择 例如：设计加出版，设计变更
    base.directive("specificProjectDialog", function () {
		return {
			restrict: "A",
			templateUrl: "/pm/commonjs/temp/projectMessage.html",
			scope: {
				showDialog: "=",
				// mdmcode: "=",
				modalTitle: "@",
				confirmButton: "@",
				onSelectedConfirm: "&",
				schCode:"=",
				projectId:"=",
				projType:"="
			},
			compile: function (element, attrs) {
				return function (scope, element, attrs) {
					scope.dbSelected = function (node) {
						if (scope.onSelected) {
							scope.onSelected();
						}
						angular.element(element.children("div")[0]).modal("hide");
					};
				}
			},
			controller: ["$scope", "commonProjectService", function ($scope, commonProjectService) {
				
				//打开窗口时查询
	            $scope.onShow = function(){
	            	$scope.getProjectList();
	            }
				var view = {
						showMask : false,
						selectedProject: null,
			    		totalPage : 0,
			    		totalCount : 0,
			    		pageSize : 5,
			    		currentPage : 1,
			    		projectVO : [],
			    		deptDialog:false
			    	}
		    	/*
		    	 * 往后台传递的参数(后台要的) 
		    	 */
				$scope.ProjectType = {
						GC:"工程项目",	
						SJ:"设计项目",	
						JL:"监理项目",	
						QT:"其它项目",	
						GY:"应急项目"	
					}
		    	var data = {
		    			data: {
		    				projShortname:"",
		    				projCode:"",
		    				projCustomCode:"",
		    				chargeOrgName:"",
		    				pmName:"",
		    				projStatus:"",
		    				projNature:"",
		    				projOwnerCode:"",
		    				projType:"",
		                },
		                pageSize: 5,
		    			currentPage: 1,
		    			totalCount: 0
		            };
				$scope.view = view;
				$scope.data = data;
				$scope.getProjectList = function getProjectList(){
					var pb = {
							pageSize : data.pageSize,
							currentPage : data.currentPage,
							totalCount : data.totalCount,
							data : [{
								projCode : data.data.projCode,
								chargeOrg : data.data.chargeOrgId,
								projName : data.data.projName == undefined ? '' : $scope.projName,
								projShortname : data.data.projShortname,
								projCustomCode : data.data.projCustomCode,
								projNature : data.data.projNature,
								projType : $scope.projType,
								projOwnerCode :data.data.projOwnerCode,
								projStatus : data.data.projStatus,
								chargeOrgName : data.data.chargeOrgName,
								pmName : data.data.pmName,
								pmId : data.data.pmId,
								schCode : $scope.schCode == undefined ? '' : $scope.schCode,
							}]
						}
					commonProjectService.selDesignStopProject(pb, function (data) {
						view.projectVO = data.data;
						view.totalPage = data.totalPage;
						view.pageSize = data.pageSize;
						view.currentPage = data.currentPage;
						view.totalCount = data.totalCount; 
						view.showMask = false;
					}, function (error) {
						view.showMask = false;
						window.alert(error);
					});
				}
				if($scope.projectId){
					$scope.getProjectList();
					$scope.$emit('to-parent', view.projectVO);
				}
				//$scope.getProjectList();	
				
				//获取部门
				$scope.selectDept = function (id,name){
					data.data.chargeOrgId = id;
					data.data.chargeOrgName = name;
				}
				// 项目经理选择回调
	            $scope.selectProjectManager = function (userId, userName) {
	            	data.data.pmId = userId;
	                data.data.pmName = userName;
	            };
				$scope.switchPage = function (currentPage, pageSize) {
					view.showMask = true;
					data.currentPage = currentPage;
					data.pageSize = pageSize;
					$scope.getProjectList();
				};
								$scope.selectProject = function(data){
					$scope.view.selectedProject = data;
				}
				
				/**
				 * 项目信息回调
				 */
				$scope.onSelected = function () {
					if ($scope.onSelectedConfirm) {
						$scope.onSelectedConfirm({
							projectVO : view.selectedProject,
						});
						$scope.$emit('to-parent', view.selectedProject);
					}
				};
    	        
    			//清空
				  $scope.clearUp = function(){
				
				    				data.data.projShortname="";
				    				data.data.projCode="";
				    				data.data.projCustomCode="";
				    				data.data.chargeOrgName="";
				    				data.data.chargeOrgId="";
				    				data.data.projOwnerCode="";
				    				data.data.pmId="";
				    				data.data.pmName="";
				    				data.data.projStatus="";
				    				data.data.projNature="";
				    				data.data.projType="";
				    				data.data.projOwnerCode="";
				      
				            
				  };
				//双击
				$scope.dbSelected = function (data) {
					$scope.view.selectedProject = data;
					$scope.onSelected();
				}
				
			}]
		}
	});
/**--------------------------------------------------------查询项目公共指令结束--------------------------------------------------------------*/    
    /**
     * 详情页面弹出框公共指令
     */
    base.factory("windowOpenService", [function () {
        return {
        	windowOpen: function (url) {
    	    	window.open(url,"","top=0,left=0,height="+(screen.availHeight-65)+",width="+(screen.availWidth-15)+",fullscreen,status=no,toolbar=no,menubar=no,location=no,resizable=1,scrollbars=1",true);
            }
        };
    }]);
    
    
    /**
     * 选择项目外部页面 
     */
})();